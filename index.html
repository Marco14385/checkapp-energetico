<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckApp Energetico</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b6cff" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="favicon.png" />

  <style>
    :root { --bg:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --shadow:0 10px 30px rgba(15,23,42,.08); --radius:18px; }
    *{box-sizing:border-box;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
      background:radial-gradient(1200px 800px at 20% 0%, rgba(11,108,255,.10), transparent 55%),
                 radial-gradient(1000px 700px at 90% 10%, rgba(0,163,255,.10), transparent 55%), var(--bg);}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 28px;}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:14px 16px;border:1px solid var(--line);
      border-radius:var(--radius);background:rgba(255,255,255,.80);backdrop-filter:blur(10px);box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:5;}
    .brand{display:flex;align-items:center;gap:12px;min-width:240px;}
    .brand img{width:44px;height:44px;border-radius:12px;border:1px solid var(--line);box-shadow:0 6px 16px rgba(15,23,42,.10);background:#fff;}
    .brand h1{margin:0;font-size:18px;line-height:1.1;}
    .brand p{margin:3px 0 0;font-size:13px;color:var(--muted);}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    button{border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:650;
      box-shadow:0 6px 16px rgba(15,23,42,.06);}
    button.primary{border-color:rgba(11,108,255,.25);background:linear-gradient(180deg, rgba(11,108,255,.12), rgba(11,108,255,.06));}
    button:hover{transform:translateY(-1px);} button:active{transform:translateY(0);}
    .grid{margin-top:14px;display:grid;grid-template-columns:1.05fr .95fr;gap:14px;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}.topbar{position:static;}.brand{min-width:0;}}
    .card{border:1px solid var(--line);border-radius:var(--radius);background:rgba(255,255,255,.85);backdrop-filter:blur(10px);box-shadow:var(--shadow);padding:16px;}
    .card h2{margin:0 0 10px;font-size:16px;}
    .note{border:1px dashed rgba(11,108,255,.35);background:rgba(11,108,255,.06);padding:10px 12px;border-radius:14px;color:var(--muted);font-size:13px;}
    .fields{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;} .fields.one{grid-template-columns:1fr;}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:650;}
    input,select,textarea{width:100%;border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#fff;font-size:14px;outline:none;}
    textarea{min-height:86px;resize:vertical;}
    .section-title{margin-top:14px;font-size:13px;color:var(--muted);font-weight:800;letter-spacing:.02em;text-transform:uppercase;}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px;}
    .pill{border:1px solid var(--line);border-radius:999px;padding:8px 10px;font-size:13px;background:#fff;display:inline-flex;align-items:center;gap:8px;font-weight:700;}
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;}
    .band{margin-top:10px;position:relative;height:36px;border-radius:999px;border:1px solid var(--line);overflow:hidden;
      background:linear-gradient(90deg,#0b7a3d 0%,#1ea34a 10%,#4cc85a 20%,#86d96d 30%,#cfe66b 40%,#f2e85c 50%,#f7cf4d 60%,#f2a23a 70%,#e07b2d 80%,#c84a2a 90%,#b02b2b 100%);}
    .band .ticks{position:absolute;inset:0;display:grid;grid-template-columns:repeat(11,1fr);align-items:end;padding:0 10px 6px;pointer-events:none;
      color:rgba(15,23,42,.72);font-size:11px;font-weight:800;text-shadow:0 1px 0 rgba(255,255,255,.65);}
    .band .ticks span{text-align:center;}
    .pointer{position:absolute;top:-10px;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:14px solid #0f172a;
      filter:drop-shadow(0 6px 10px rgba(0,0,0,.18));transform:translateX(-10px);left:2%;}
    .box{margin-top:12px;border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;}
    .cta{display:grid;gap:10px;margin-top:10px;}
    .cta a{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border-radius:16px;border:1px solid var(--line);
      text-decoration:none;font-weight:850;color:var(--text);background:#fff;box-shadow:0 10px 24px rgba(15,23,42,.08);}
    .cta a.primary{border-color:rgba(11,108,255,.25);background:linear-gradient(180deg, rgba(11,108,255,.14), rgba(11,108,255,.07));}
    .small{color:var(--muted);font-size:12px;margin-top:8px;}
    .list{margin:0;padding-left:18px;} .list li{margin:6px 0;}
    .ready{display:flex;align-items:center;gap:10px;padding:12px;border-radius:14px;border:1px solid var(--line);background:#fff;margin-top:10px;}
    .badge{font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;white-space:nowrap;}
    .footer{margin-top:14px;color:var(--muted);font-size:12px;text-align:center;}
    @media print{.topbar,.footer{display:none;} body{background:#fff;} .wrap{padding:0;} .card{box-shadow:none;backdrop-filter:none;background:#fff;} .grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img src="icon-192.png" alt="logo" />
        <div>
          <h1>CheckApp Energetico</h1>
          <p>Screening orientativo + interventi prioritari (non APE). Utile quanto basta per decidere il prossimo passo.</p>
        </div>
      </div>
      <div class="actions">
        <button id="btnCalc" class="primary">‚ö° Calcola</button>
        <button id="btnSave">üíæ Salva</button>
        <button id="btnLoad">üìÇ Carica</button>
        <button id="btnPdf">üßæ Report PDF</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Dati immobile</h2>
        <div class="note"><b>Disclaimer:</b> output indicativo. Per certificazione APE servono rilievi e calcoli secondo normativa vigente. Qui stimiamo una <b>classe</b> e un <b>livello di criticit√†</b>.</div>

        <div class="fields">
          <div><label>Cliente / riferimento (facoltativo)</label><input id="cliente" placeholder="Es. Rossi Mario" /></div>
          <div><label>Comune (facoltativo)</label><input id="comune" placeholder="Es. Roma" /></div>
          <div><label>Superficie (m¬≤)</label><input id="superficie" type="number" value="80" min="10" /></div>
          <div><label>Altezza media (m)</label><input id="altezza" type="number" value="2.7" min="2" step="0.1" /></div>
          <div style="grid-column:1/-1;">
            <label>Anno di costruzione / ristrutturazione principale</label>
            <select id="anno">
              <option value="post2015">2015+</option>
              <option value="2006_2014">2006‚Äì2014</option>
              <option value="1991_2005">1991‚Äì2005</option>
              <option value="1970_1990" selected>1970‚Äì1990</option>
              <option value="pre70">Prima del 1970</option>
            </select>
          </div>
          <div><label>Zona climatica (indicativa)</label>
            <select id="zona"><option>A</option><option>B</option><option>C</option><option selected>D</option><option>E</option><option>F</option></select>
          </div>
          <div><label>Orientamento prevalente</label>
            <select id="orientamento"><option value="N">Nord</option><option value="E">Est</option><option value="S" selected>Sud</option><option value="O">Ovest</option><option value="NE">Nord-Est</option><option value="NO">Nord-Ovest</option><option value="SE">Sud-Est</option><option value="SO">Sud-Ovest</option></select>
          </div>
          <div><label>Tipologia</label>
            <select id="tipologia"><option value="appartamento" selected>Appartamento</option><option value="villa">Villetta / Unifamiliare</option><option value="ufficio">Ufficio</option></select>
          </div>
          <div><label>Posizione</label>
            <select id="posizione"><option value="intermedio" selected>Intermedio</option><option value="ultimo">Ultimo piano</option><option value="terra">Piano terra</option><option value="attico">Attico</option></select>
          </div>
        </div>

        <div class="section-title">Aperture</div>
        <div class="fields">
          <div><label>Numero finestre</label><input id="num_finestre" type="number" value="6" min="0" /></div>
          <div><label>Numero porte-finestra</label><input id="num_portefinestre" type="number" value="1" min="0" /></div>
        </div>

        <div class="section-title">Involucro</div>
        <div class="fields">
          <div><label>Isolamento pareti</label><select id="pareti"><option value="buono">Buono</option><option value="medio">Medio</option><option value="scarso" selected>Assente / minimo</option></select></div>
          <div><label>Copertura / solaio verso esterno</label><select id="copertura"><option value="buona">Buona</option><option value="media" selected>Parziale</option><option value="scarsa">Assente</option></select></div>
          <div><label>Materiale infissi</label><select id="infissi_mat"><option value="pvc" selected>PVC</option><option value="legno">Legno</option><option value="alluminio">Alluminio</option></select></div>
          <div><label>Taglio termico (solo alluminio)</label><select id="taglio_termico" disabled><option value="si">S√¨</option><option value="no" selected>No</option></select></div>
          <div style="grid-column:1/-1;"><label>Vetri</label><select id="vetri"><option value="singolo">Singolo vetro</option><option value="doppio_vecchio" selected>Doppio vecchio</option><option value="doppio_bassoem">Doppio basso-emissivo</option><option value="triplo">Triplo</option></select></div>
          <div><label>Tenuta aria (spifferi)</label><select id="aria"><option value="buona">Buona</option><option value="media">Media</option><option value="scarsa" selected>Scarsa</option></select></div>
          <div><label>Ombreggiamento</label><select id="ombreggiamento"><option value="si">S√¨</option><option value="no" selected>No</option></select></div>
        </div>

        <div class="section-title">Impianti</div>
        <div class="fields">
          <div><label>Riscaldamento</label><select id="riscaldamento"><option value="assente">Assente</option><option value="centralizzato" selected>Condominiale / centralizzato</option><option value="autonomo_caldaia">Autonomo caldaia</option><option value="pdc">Pompa di calore (PDC)</option><option value="altro">Altro</option></select></div>
          <div><label>Terminali</label><select id="terminali"><option value="radiatori" selected>Radiatori</option><option value="fan_coil">Fan-coil</option><option value="pavimento">Pavimento radiante</option><option value="aria">Aria (canalizzato)</option></select></div>
          <div><label>Raffrescamento presente?</label><select id="raffrescamento"><option value="no" selected>No</option><option value="si">S√¨</option></select></div>
          <div><label>Tipo raffrescamento</label><select id="raff_tipo" disabled><option value="pdc">PDC</option><option value="chiller">Chiller</option><option value="dx">Espansione diretta</option></select></div>
          <div><label>ACS</label><select id="acs"><option value="gas" selected>Gas</option><option value="pdc">PDC / boiler HP</option><option value="elettrico">Elettrico</option><option value="solare">Solare termico</option></select></div>
          <div><label>Fotovoltaico</label><select id="fv"><option value="no" selected>No</option><option value="si">S√¨</option></select></div>
        </div>

        <div class="section-title">Note</div>
        <div class="fields one"><div><label>Note (facoltative)</label><textarea id="note" placeholder="Es. vincoli condominiali, budget, obiettivi, ecc."></textarea></div></div>
      </div>

      <div class="card">
        <h2>Risultato</h2>

        <div class="pillrow">
          <span class="pill"><span id="statusDot" class="dot"></span><span id="statusText">In attesa di calcolo</span></span>
          <span class="pill">Indice: <span id="indiceTxt">‚Äî</span></span>
          <span class="pill">Classe: <span id="classeTxt">‚Äî</span></span>
          <span class="pill">Volume: <span id="volTxt">‚Äî</span> m¬≥</span>
        </div>

        <div class="band">
          <div id="pointer" class="pointer"></div>
          <div class="ticks"><span>NZEB</span><span>A4</span><span>A3</span><span>A2</span><span>A1</span><span>B</span><span>C</span><span>D</span><span>E</span><span>F</span><span>G</span></div>
        </div>

        <div class="ready">
          <span class="badge" id="readyBadge">2030: non calcolato</span>
          <div style="color:var(--muted);font-size:13px;" id="readyText">Compila i dati e premi Calcola.</div>
        </div>

        <div class="section-title">Interventi consigliati</div>
        <div class="box"><ul class="list" id="interventiList"><li>‚Äî</li></ul></div>

        <div class="section-title">Prossimo passo</div>
        <div class="box">
          Se vuoi numeri veri: sopralluogo + APE/diagnosi + piano interventi.
          <div class="cta">
            <a id="ctaEmail" class="primary" href="#">üì© Prenota sopralluogo (Email)</a>
            <a id="ctaWa" href="#">üí¨ Prenota su WhatsApp</a>
          </div>
          <div class="small">Email: <b id="mailShow">marco.hotplay@hotmail.it</b> ¬∑ WhatsApp Business: <b>+39 346 315 6763</b></div>
        </div>

        <div class="footer">Versione: <span id="ver">v13-1766950936</span> ¬∑ Offline: s√¨ (PWA)</div>
      </div>
    </div>
  </div>

  <script>
  "use strict";
const EMAIL_TO="marco.hotplay@hotmail.it";
const WA_NUMBER="393463156763";
const VERSION="v13-1766950936";

const $=(id)=>document.getElementById(id);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const CLASSES=["NZEB","A4","A3","A2","A1","B","C","D","E","F","G"];

function volume(){const s=parseFloat($("superficie").value||"0"); const h=parseFloat($("altezza").value||"0"); return Math.round((s*h)*10)/10;}
function classFromScore(score){
  const s=clamp(score,0,100);
  if(s<=5)return"NZEB"; if(s<=12)return"A4"; if(s<=18)return"A3"; if(s<=25)return"A2"; if(s<=33)return"A1";
  if(s<=42)return"B"; if(s<=52)return"C"; if(s<=63)return"D"; if(s<=75)return"E"; if(s<=88)return"F"; return"G";
}
function positionForClass(cls){const i=CLASSES.indexOf(cls); const idx=i<0?10:i; return 2+(idx*(96/10));}

function computeScore(){
  const year=$("anno").value, zona=$("zona").value;
  let score=40;
  if(year==="post2015")score-=18; else if(year==="2006_2014")score-=10; else if(year==="1991_2005")score-=2; else if(year==="1970_1990")score+=8; else if(year==="pre70")score+=18;
  const zonePenalty={A:-4,B:-2,C:2,D:6,E:10,F:14}[zona] ?? 6; score+=zonePenalty;

  const pareti=$("pareti").value, cop=$("copertura").value, aria=$("aria").value, vetri=$("vetri").value;
  score += (pareti==="buono")?-10:(pareti==="medio"?-4:10);
  score += (cop==="buona")?-6:(cop==="media"?2:8);
  score += (aria==="buona")?-6:(aria==="media"?2:8);
  score += (vetri==="triplo")?-8:(vetri==="doppio_bassoem"?-5:(vetri==="doppio_vecchio"?2:10));

  const mat=$("infissi_mat").value;
  if(mat==="pvc")score-=2;
  if(mat==="legno")score-=1;
  if(mat==="alluminio"){const tt=$("taglio_termico").value; score += (tt==="si")?1:8;}

  const ori=$("orientamento").value, shade=$("ombreggiamento").value;
  if(["S","SO","SE","O"].includes(ori) && shade==="no")score+=3;
  if(["N","NE","NO"].includes(ori))score+=1;

  const nfin=parseInt($("num_finestre").value||"0",10);
  const npf=parseInt($("num_portefinestre").value||"0",10);
  const openings=clamp(nfin+(npf*2),0,30);
  score += clamp((openings-6)*0.6,-4,10);

  const ris=$("riscaldamento").value, term=$("terminali").value, raff=$("raffrescamento").value, raffTipo=$("raff_tipo").value;
  const acs=$("acs").value, fv=$("fv").value;

  if(ris==="assente")score+=6;
  if(ris==="centralizzato")score+=2;
  if(ris==="autonomo_caldaia")score+=3;
  if(ris==="pdc")score-=6;

  if(term==="pavimento")score-=2;
  if(term==="fan_coil")score-=1;

  if(raff==="si"){
    if(raffTipo==="pdc")score-=1;
    if(raffTipo==="chiller")score+=2;
    if(raffTipo==="dx")score+=1;
  }

  if(acs==="pdc")score-=3;
  if(acs==="solare")score-=4;
  if(acs==="elettrico")score+=2;
  if(fv==="si")score-=6;

  const pos=$("posizione").value;
  if(pos==="ultimo"||pos==="attico")score+=4;
  if(pos==="terra")score+=2;

  return Math.round(clamp(score,0,100));
}

function interventions(d){
  const out=[];
  if(d.pareti==="scarso") out.push("Isolamento pareti (cappotto mirato o insufflaggio): riduce dispersioni e migliora comfort.");
  if(d.aria==="scarsa") out.push("Tenuta all‚Äôaria: guarnizioni, cassonetti, sigillature (spesso low-cost, alta resa).");
  if(["singolo","doppio_vecchio"].includes(d.vetri)) out.push("Upgrade vetri/infissi: basso emissivo + posa corretta (ponti termici).");
  if(d.copertura==="scarsa"||d.copertura==="media") out.push("Coibentazione copertura/solaio verso esterno: prioritaria se ultimo piano/attico.");
  if(d.riscaldamento!=="pdc") out.push("Valuta PDC (dove possibile): taglia consumi e prepara l‚Äôimmobile alla decarbonizzazione.");
  if(d.fv==="no") out.push("Fotovoltaico (se fattibile): supporta consumi e futura PDC/raffrescamento.");
  if(d.raffrescamento==="si" && d.raff_tipo==="chiller") out.push("Raffrescamento: verifica efficienza chiller e regolazione (spesso margine enorme).");
  if(d.raffrescamento==="si" && d.raff_tipo==="dx") out.push("Raffrescamento DX: manutenzione + corretto dimensionamento/posa per evitare sprechi.");
  if(out.length===0) out.push("Nessuna criticit√† evidente: verifica comunque con diagnosi/sopralluogo se vuoi numeri reali.");
  return out.slice(0,8);
}

function isReady2030(cls){return CLASSES.indexOf(cls) < CLASSES.indexOf("D");}

function syncLogic(){
  const mat=$("infissi_mat").value;
  $("taglio_termico").disabled = (mat!=="alluminio");
  if(mat!=="alluminio") $("taglio_termico").value="no";

  const r=$("raffrescamento").value;
  $("raff_tipo").disabled = (r!=="si");
  if(r!=="si") $("raff_tipo").value="pdc";
}

function collect(){
  return {
    cliente:$("cliente").value.trim(),
    comune:$("comune").value.trim(),
    superficie:$("superficie").value, altezza:$("altezza").value,
    anno:$("anno").value, zona:$("zona").value, orientamento:$("orientamento").value,
    tipologia:$("tipologia").value, posizione:$("posizione").value,
    num_finestre:$("num_finestre").value, num_portefinestre:$("num_portefinestre").value,
    pareti:$("pareti").value, copertura:$("copertura").value,
    infissi_mat:$("infissi_mat").value, taglio_termico:$("taglio_termico").value,
    vetri:$("vetri").value, aria:$("aria").value, ombreggiamento:$("ombreggiamento").value,
    riscaldamento:$("riscaldamento").value, terminali:$("terminali").value,
    raffrescamento:$("raffrescamento").value, raff_tipo:$("raff_tipo").value,
    acs:$("acs").value, fv:$("fv").value,
    note:$("note").value.trim(), _version:VERSION
  };
}

function apply(d){
  Object.keys(d||{}).forEach(k=>{const el=$(k); if(el) el.value=d[k];});
  syncLogic(); setCtas();
}

function setCtas(){
  const subject=encodeURIComponent("Prenotazione sopralluogo / APE");
  const body=encodeURIComponent(
    "Ciao Marco,\n\nVorrei prenotare un sopralluogo/APE.\n\nDati immobile (se li hai):\n- Comune: "+($("comune").value||"")+
    "\n- Superficie: "+($("superficie").value||"")+" m¬≤\n- Note: "+($("note").value||"")+"\n\nGrazie!"
  );
  $("ctaEmail").href=`mailto:${EMAIL_TO}?subject=${subject}&body=${body}`;
  const waText=encodeURIComponent("Ciao Marco, vorrei prenotare un sopralluogo/APE. Comune: "+($("comune").value||"")+", superficie: "+($("superficie").value||"")+" m¬≤.");
  $("ctaWa").href=`https://wa.me/${WA_NUMBER}?text=${waText}`;
}

function calc(){
  syncLogic();
  const v=volume(); $("volTxt").textContent=String(v);
  const score=computeScore(); const cls=classFromScore(score);
  $("indiceTxt").textContent=String(score); $("classeTxt").textContent=cls;
  $("statusDot").style.background = (score<=42)?"#16a34a":(score<=63?"#f59e0b":"#ef4444");
  $("statusText").textContent = (score<=42)?"Buono":(score<=63?"Medio":"Critico");
  $("pointer").style.left = positionForClass(cls)+"%";

  const ready=isReady2030(cls);
  $("readyBadge").textContent = ready?"2030: OK":"2030: NON OK";
  $("readyBadge").style.borderColor = ready?"rgba(22,163,74,.35)":"rgba(239,68,68,.35)";
  $("readyBadge").style.background = ready?"rgba(22,163,74,.06)":"rgba(239,68,68,.06)";
  $("readyText").textContent = ready
    ? "Se resti almeno in classe C (o meglio), sei dentro alla logica 'pronto'."
    : "Se resti in D/E/F/G, serve un piano interventi per arrivare almeno a C.";

  const data=collect();
  const list=interventions(data);
  const ul=$("interventiList"); ul.innerHTML="";
  list.forEach(it=>{const li=document.createElement("li"); li.textContent=it; ul.appendChild(li);});
  setCtas();
  return {score,cls,v,data,list,ready};
}

function saveDraft(){localStorage.setItem("checkapp_energetico_draft", JSON.stringify(collect())); alert("Salvato sul dispositivo.");}
function loadDraft(){const raw=localStorage.getItem("checkapp_energetico_draft"); if(!raw) return alert("Nessun salvataggio trovato.");
  try{apply(JSON.parse(raw)); alert("Caricato.");}catch{alert("Salvataggio non leggibile (vecchio/corrotto).");}}

function reportPDF(){
  const res=calc(); const d=res.data;
  const base=location.href.replace(/\?.*$/,"").replace(/index\.html$/,"");
  const logoUrl=base+"icon-192.png";
  const safe=(s)=>String(s||"‚Äî").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const ptrLeft=positionForClass(res.cls);

  const html=`<!doctype html><html lang="it"><head><meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/><title>Report CheckApp Energetico</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px;color:#0f172a;}
    .head{display:flex;align-items:center;gap:14px;margin-bottom:14px;}
    .logo{width:56px;height:56px;border-radius:16px;border:1px solid #e2e8f0;}
    h1{margin:0;font-size:22px;}
    .muted{color:#475569;font-size:13px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
    .card{border:1px solid #e2e8f0;border-radius:16px;padding:12px;}
    .k{color:#64748b;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.02em;margin-bottom:6px;}
    .v{font-size:14px;font-weight:650;}
    .band{margin-top:10px;height:18px;border-radius:999px;border:1px solid #e2e8f0;background:linear-gradient(90deg,#0b7a3d 0%,#1ea34a 10%,#4cc85a 20%,#86d96d 30%,#cfe66b 40%,#f2e85c 50%,#f7cf4d 60%,#f2a23a 70%,#e07b2d 80%,#c84a2a 90%,#b02b2b 100%);position:relative;overflow:hidden;}
    .ptr{position:absolute;top:-8px;left:${ptrLeft}%;transform:translateX(-6px);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:10px solid #0f172a;}
    ul{margin:8px 0 0;padding-left:18px;}
    @media print{button{display:none;}}
  </style></head><body>
    <div class="head"><img class="logo" src="${logoUrl}" alt="logo"/><div><h1>Report CheckApp Energetico</h1><div class="muted">Output indicativo (non APE) ¬∑ Versione: ${VERSION}</div></div></div>

    <div class="card">
      <div class="k">Esito</div>
      <div class="v">Indice: <b>${res.score}</b>/100 ¬∑ Classe stimata: <b>${res.cls}</b> ¬∑ Volume: <b>${res.v}</b> m¬≥ ¬∑ 2030: <b>${res.ready ? "OK" : "NON OK"}</b></div>
      <div class="band"><div class="ptr"></div></div>
      <div class="muted" style="margin-top:8px;">Regola 2030: ‚Äúpronto‚Äù se classe <b>C o migliore</b> (quindi sopra D).</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="k">Immobile</div>
        <div class="v">Cliente: ${safe(d.cliente)} ¬∑ Comune: ${safe(d.comune)}</div>
        <div class="v">Sup: ${safe(d.superficie)} m¬≤ ¬∑ H: ${safe(d.altezza)} m ¬∑ Anno: ${safe(d.anno)} ¬∑ Zona: ${safe(d.zona)}</div>
        <div class="v">Tipologia: ${safe(d.tipologia)} ¬∑ Posizione: ${safe(d.posizione)} ¬∑ Orientamento: ${safe(d.orientamento)}</div>
        <div class="v">Finestre: ${safe(d.num_finestre)} ¬∑ Porte-finestra: ${safe(d.num_portefinestre)}</div>
      </div>

      <div class="card">
        <div class="k">Involucro & Impianti</div>
        <div class="v">Pareti: ${safe(d.pareti)} ¬∑ Copertura: ${safe(d.copertura)} ¬∑ Spifferi: ${safe(d.aria)}</div>
        <div class="v">Infissi: ${safe(d.infissi_mat)} ¬∑ Taglio termico: ${safe(d.taglio_termico)} ¬∑ Vetri: ${safe(d.vetri)}</div>
        <div class="v">Risc.: ${safe(d.riscaldamento)} ¬∑ Terminali: ${safe(d.terminali)}</div>
        <div class="v">Raffresc.: ${safe(d.raffrescamento)} ${d.raffrescamento==="si" ? "(" + safe(d.raff_tipo) + ")" : ""} ¬∑ ACS: ${safe(d.acs)} ¬∑ FV: ${safe(d.fv)}</div>
      </div>

      <div class="card" style="grid-column:1/-1;">
        <div class="k">Interventi consigliati</div>
        <ul>${res.list.map(x=>"<li>"+safe(x)+"</li>").join("")}</ul>
      </div>

      <div class="card" style="grid-column:1/-1;">
        <div class="k">Note</div>
        <div class="v">${safe(d.note)}</div>
      </div>
    </div>

    <p class="muted" style="margin-top:14px;">Contatti: ${EMAIL_TO} ¬∑ WhatsApp: +39 346 315 6763</p>
    <button onclick="window.print()">Stampa / Salva PDF</button>
  </body></html>`;

  const w=window.open("","_blank"); w.document.open(); w.document.write(html); w.document.close();
}

function wire(){
  $("btnCalc").addEventListener("click",(e)=>{e.preventDefault(); calc();});
  $("btnSave").addEventListener("click",(e)=>{e.preventDefault(); saveDraft();});
  $("btnLoad").addEventListener("click",(e)=>{e.preventDefault(); loadDraft();});
  $("btnPdf").addEventListener("click",(e)=>{e.preventDefault(); reportPDF();});
  $("infissi_mat").addEventListener("change", syncLogic);
  $("raffrescamento").addEventListener("change", syncLogic);
  document.addEventListener("input", setCtas);
  syncLogic(); setCtas();
}

if("serviceWorker" in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("./service-worker.js").catch(()=>{});});}
wire();
  </script>
</body>
</html>