<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>CheckApp Energetico | Screening orientativo</title>
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" href="icon-192.png" type="image/png">
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.json" />
  <style>
  :root{
    --bg:#ffffff;
    --bg2:#f5f7fb;
    --panel:#ffffff;
    --panel2:#ffffff;
    --line:rgba(10,20,40,.12);
    --text:#0b1220;
    --muted:rgba(11,18,32,.72);
    --muted2:rgba(11,18,32,.55);
    --shadow:0 18px 50px rgba(16,24,40,.12);
    --shadow2:0 10px 25px rgba(16,24,40,.10);
    --radius:18px;
    --radius2:14px;
    --gap:16px;
    --accent:#2563eb;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#ef4444;
    --chip:#eef2ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    background: radial-gradient(1200px 600px at 20% 0%, #eef2ff 0%, rgba(255,255,255,0) 55%),
                radial-gradient(1000px 500px at 80% 10%, #fef3c7 0%, rgba(255,255,255,0) 55%),
                linear-gradient(180deg,var(--bg),var(--bg2));
    color:var(--text);
    min-height:100vh;
  }
  a{color:inherit}
  .wrap{max-width:1180px;margin:26px auto;padding:0 16px}
  .topbar{
    display:flex;align-items:center;gap:16px;justify-content:space-between;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:24px;
    padding:16px 18px;
    box-shadow:var(--shadow);
    position:sticky;top:12px;z-index:5;
    backdrop-filter:saturate(160%) blur(10px);
  }
  .brand{display:flex;align-items:center;gap:14px;min-width:260px}
  .logoImg{
    width:44px;height:44px;border-radius:12px;
    border:1px solid rgba(10,20,40,.10);
    box-shadow:0 8px 18px rgba(16,24,40,.10);
    background:#fff;
    object-fit:cover;
  }
  .title{display:flex;flex-direction:column;line-height:1.1}
  .title b{font-size:18px}
  .title span{font-size:12.5px;color:var(--muted)}
  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .btn{
    background:var(--panel);
    border:1px solid var(--line);
    color:var(--text);
    border-radius:14px;
    padding:10px 12px;
    display:inline-flex;align-items:center;gap:10px;
    cursor:pointer;
    box-shadow:var(--shadow2);
    transition:transform .06s ease, box-shadow .15s ease;
    user-select:none;
    text-decoration:none;
    font-weight:600;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0px);box-shadow:0 6px 14px rgba(16,24,40,.12)}
  .btn.primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border-color:rgba(37,99,235,.35)}
  .btn.whatsapp{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border-color:rgba(34,197,94,.35)}
  .btn.ghost{background:transparent;box-shadow:none}
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:var(--gap);margin-top:18px}
  @media (max-width: 980px){.grid{grid-template-columns:1fr} .topbar{position:relative;top:auto}}
  .card{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
  }
  .card h2{margin:0 0 12px 0;font-size:16px}
  .subnote{
    background:linear-gradient(135deg,#eef2ff, #ffffff);
    border:1px solid rgba(37,99,235,.15);
    border-radius:14px;
    padding:12px 12px;
    color:var(--muted);
    font-size:13px;
  }
  .subnote b{color:var(--text)}
  .fields{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  @media (max-width: 640px){.fields{grid-template-columns:1fr}}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px;font-weight:600}
  input,select{
    width:100%;
    background:#fff;
    border:1px solid rgba(10,20,40,.14);
    color:var(--text);
    border-radius:14px;
    padding:12px 12px;
    outline:none;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
  }
  input::placeholder{color:rgba(11,18,32,.35)}
  input:focus,select:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
  .sectionTitle{margin-top:16px;font-size:13px;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.06em}
  .chips{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
  .chip{padding:8px 10px;border:1px solid var(--line);background:var(--chip);border-radius:999px;font-size:12.5px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
  .dot.ok{background:var(--ok)}
  .dot.bad{background:var(--bad)}
  .resultRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .metric{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:999px;
    padding:10px 12px;
    font-weight:800;
    font-size:13px;
    color:var(--text);
    display:flex;gap:8px;align-items:center;
  }
  .barWrap{margin-top:14px}
  .band{
    width:100%;
    height:36px;
    border-radius:14px;
    border:1px solid var(--line);
    overflow:hidden;
    display:flex;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
  }
  .seg{flex:1}
  .segLabel{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:8px;padding:0 4px}
  .pointer{width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:14px solid rgba(11,18,32,.8);transform:translateX(0);transition:transform .3s ease}
  .pointerWrap{display:flex;justify-content:flex-start;margin-top:8px}
  .divider{height:1px;background:rgba(10,20,40,.10);margin:16px 0}
  .list{padding-left:16px;margin:8px 0;color:var(--muted)}
  .next{color:var(--muted);font-size:13px;line-height:1.35}
  .cta{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  .jsonBox{
    width:100%;min-height:70px;border-radius:14px;border:1px solid rgba(10,20,40,.14);
    background:#fff;color:rgba(11,18,32,.75);padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top no-print">
      <div class="brand">
        <img class="logoImg" src="icon-192.png" alt="CheckApp Energetico">
        <div>
          <div class="title">CheckApp Energetico</div>
          <div class="subtitle">Screening orientativo + interventi prioritari (non APE). Bello quanto basta per non vergognarsene.</div>
        </div>
      </div>
      <div class="actions">
        <button onclick="saveDraft()"><span>üíæ</span><span>Salva</span></button>
        <button onclick="loadDraft()"><span>üìÇ</span><span>Carica</span></button>
        <button onclick="exportPDF()"><span>üßæ</span><span>Report PDF</span></button>
      </div>
    </div>

    <div class="grid">
      <div class="card no-print">
        <h2>Dati immobile</h2>
        <div class="subnote">
          <b>Disclaimer:</b> output indicativo. Per certificazione APE servono rilievi e calcoli secondo normativa vigente.<br>
          <b>Test 2030 (orientativo):</b> se la classe stimata √® <b>D o superiore</b> sei ‚Äúpi√π vicino‚Äù ai requisiti 2030; se √® <b>E/F/G</b> servono interventi (involucro + impianti) per salire di classe.
        </div>

        <div class="row2">
          <div>
            <label>Cliente / riferimento (facoltativo)</label>
            <input id="client" placeholder="Es. Rossi Mario">
          </div>
          <div>
            <label>Comune (facoltativo)</label>
            <input id="city" placeholder="Es. Roma">
          </div>
        </div>

        <div class="row2">
          <div>
            <label>Superficie (m¬≤)</label>
            <input id="area" type="number" min="10" step="1" value="80">
          </div>
          <div>
            <label>Altezza media (m)</label>
            <input id="height" type="number" min="2.2" max="3.5" step="0.1" value="2.7">
          </div>
        </div>

        <label>Anno di costruzione / ristrutturazione principale</label>
        <select id="yearBand">
          <option value="pre70">Prima del 1970</option>
          <option value="70_90" selected>1970‚Äì1990</option>
          <option value="91_05">1991‚Äì2005</option>
          <option value="06_15">2006‚Äì2015</option>
          <option value="16plus">Dal 2016 in poi</option>
        </select>

        <label>Zona climatica (indicativa)</label>
        <select id="climate">
          <option value="A">A (molto mite)</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D" selected>D</option>
          <option value="E">E</option>
          <option value="F">F (molto fredda)</option>
        </select>

        <div class="row2">
          <div>
            <label>Tipologia</label>
            <select id="type">
              <option value="apartment" selected>Appartamento</option>
              <option value="house">Casa indipendente / villa</option>
            </select>
          </div>
          <div>
            <label>Posizione</label>
            <select id="exposure">
              <option value="middle" selected>Intermedio</option>
              <option value="top">Ultimo piano / sottotetto</option>
              <option value="ground">Piano terra / sopra locali freddi</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>
        <h2>Involucro</h2>

        <label>Isolamento pareti</label>
        <select id="wallIns">
          <option value="none" selected>Assente / minimo</option>
          <option value="some">Parziale</option>
          <option value="good">Buono (recente)</option>
        </select>

        <div class="row2">
          <div>
            <label>Infissi</label>
            <select id="windows">
              <option value="single" selected>Vecchi / singolo vetro</option>
              <option value="double_old">Doppio vetro datato</option>
              <option value="double_new">Doppio/triplo recente</option>
            </select>
          </div>
          <div>
            <label>Tenuta aria (spifferi)</label>
            <select id="airtight">
              <option value="poor" selected>Scarsa</option>
              <option value="avg">Media</option>
              <option value="good">Buona</option>
            </select>
          </div>
        </div>

        <label>Isolamento copertura / solaio</label>
        <select id="roofIns">
          <option value="none" selected>Assente</option>
          <option value="some">Parziale</option>
          <option value="good">Buono</option>
        </select>

        <div class="divider"></div>
        <h2>Impianti</h2>

        <label>Riscaldamento</label>
        <select id="heat">
          <option value="old_boiler" selected>Caldaia tradizionale datata</option>
          <option value="condensing">Caldaia a condensazione</option>
          <option value="hp">Pompa di calore</option>
          <option value="district">Teleriscaldamento</option>
          <option value="stove">Stufa / pellet principale</option>
        </select>

        <div class="row2">
          <div>
            <label>Terminali</label>
            <select id="emitters">
              <option value="radiators" selected>Radiatori</option>
              <option value="floor">Pavimento radiante</option>
              <option value="fan">Ventilconvettori / split</option>
            </select>
          </div>
          <div>
            <label>Regolazione</label>
            <select id="controls">
              <option value="none" selected>Basica / assente</option>
              <option value="thermostat">Termostato</option>
              <option value="smart">Smart + valvole/zone</option>
            </select>
          </div>
        </div>

        <div class="row2">
          <div>
            <label>ACS</label>
            <select id="dhw">
              <option value="old" selected>Boiler/ACS datata</option>
              <option value="condensing">Da caldaia a condensazione</option>
              <option value="hp">PDC per ACS</option>
              <option value="solar">Solare termico</option>
            </select>
          </div>
          <div>
            <label>Fotovoltaico</label>
            <select id="pv">
              <option value="none" selected>Assente</option>
              <option value="small">Piccolo (1‚Äì3 kWp)</option>
              <option value="med">Medio (3‚Äì6 kWp)</option>
              <option value="large">Grande (&gt;6 kWp)</option>
            </select>
          </div>
        </div>

        <label>Note (facoltative)</label>
        <textarea id="notes" placeholder="Es. infissi cambiati lato sud, caldaia 2012, ultimo piano..."></textarea>

        <div class="actions" style="margin-top:14px">
          <button class="primary" onclick="calc()"><span>‚ö°</span><span>Calcola</span></button>
          <button onclick="resetForm()"><span>‚Ü©Ô∏è</span><span>Reset</span></button>
          <button onclick="copySummary()"><span>üìã</span><span>Copia JSON</span></button>
        </div>

        <p class="small" style="margin-top:10px">Tip: fai ‚ÄúCalcola‚Äù davanti al cliente, poi ‚ÄúReport PDF‚Äù e hai gi√† un promemoria pulito.</p>
      </div>

      <div class="card">
        <h2>Risultato</h2>

        <div class="pillrow">
          <span class="badge" id="sevBadge"><span class="dot warn"></span><span>In attesa di calcolo</span></span>
          <span class="pill" id="idxPill">Indice: ‚Äî</span>
          <span class="pill" id="classPill">Classe: ‚Äî</span>
          <span class="pill" id="volPill">Volume: ‚Äî</span>
        </div>

        <div class="meter" title="Pi√π √® pieno, peggio stai (ma almeno lo sai).">
          <div class="bar" id="bar"></div>
        </div>

        <div class="scale" aria-label="Scala classi energetiche">
          <div class="scaleRow">
            <div class="scaleBar">
              <div class="seg a4" title="A4"></div>
              <div class="seg a3" title="A3"></div>
              <div class="seg a2" title="A2"></div>
              <div class="seg a1" title="A1"></div>
              <div class="seg b" title="B"></div>
              <div class="seg c" title="C"></div>
              <div class="seg d" title="D"></div>
              <div class="seg e" title="E"></div>
              <div class="seg f" title="F"></div>
              <div class="seg g" title="G"></div>
            </div>
            <div class="marker"><div class="pin" id="scalePin" style="left:0%"></div></div>
            <div class="scaleLabels">
              <span>A4</span><span>A3</span><span>A2</span><span>A1</span><span>B</span><span>C</span><span>D</span><span>E</span><span>F</span><span>G</span>
            </div>
          </div>
        </div>


        <div class="divider"></div>

        <h2>Interventi consigliati</h2>
        <div id="adviceBox" class="muted">‚Äî</div>

        <div class="divider"></div>

        <h2>Prossimo passo</h2>
        <div class="muted">Se vuoi numeri veri: sopralluogo + APE/diagnosi + piano interventi.</div>
        <div class="cta">
          <a class="btn" id="ctaEmail" href="mailto:marco.hotplay@hotmail.it">Prenota sopralluogo APE (Email)</a>
          <a class="btn secondary" id="ctaWhatsApp" href="https://wa.me/393463156763" target="_blank" rel="noopener">Prenota su WhatsApp</a>
          <span class="small" id="costHint">‚Äî</span>
        </div>

        <div class="divider"></div>

        <h2>Riepilogo (JSON)</h2>
        <div id="summary" class="jsonbox">‚Äî</div>
      </div>
    </div>

    <div class="card report">
      <h2>CheckApp Energetico - Report (screening orientativo)</h2>
      <div class="small" id="printMeta"></div>
      <div class="divider"></div>
      <h2>Dati (JSON)</h2>
      <div class="jsonbox" id="printData"></div>
      <div class="divider"></div>
      <h2>Risultato</h2>
      <div id="printResult"></div>
      <div class="divider"></div>
      <h2>Interventi prioritari</h2>
      <div id="printAdvice"></div>
      <div class="divider"></div>
      <div class="small">
        Disclaimer: report orientativo. Non ha valore di APE. Per certificazioni servono rilievi e calcoli secondo normativa vigente.
      </div>
    </div>

  </div>

<script>
function v(id){ return document.getElementById(id).value; }
function n(id){ return parseFloat(document.getElementById(id).value || "0"); }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

function scoreClimate(zone){ return ({A:0, B:4, C:8, D:12, E:18, F:24})[zone] ?? 12; }
function scoreYear(band){ return ({pre70:28, "70_90":22, "91_05":16, "06_15":10, "16plus":4})[band] ?? 18; }
function scoreType(t){ return (t==="house") ? 10 : 0; }
function scoreExposure(e){ return ({middle:0, top:6, ground:5})[e] ?? 0; }
function scoreIns(val, kind){
  if(kind==="wall") return ({none:18, some:10, good:4})[val] ?? 12;
  if(kind==="roof") return ({none:10, some:6, good:2})[val] ?? 6;
  return 0;
}
function scoreWindows(w){ return ({single:14, double_old:8, double_new:3})[w] ?? 10; }
function scoreAirtight(a){ return ({poor:8, avg:4, good:1})[a] ?? 4; }
function scoreHeat(h){ return ({old_boiler:18, condensing:10, hp:4, district:8, stove:12})[h] ?? 12; }
function scoreEmitters(e){ return ({radiators:6, floor:2, fan:4})[e] ?? 4; }
function scoreControls(c){ return ({none:6, thermostat:3, smart:1})[c] ?? 3; }
function scoreDHW(d){ return ({old:8, condensing:4, hp:2, solar:1})[d] ?? 4; }
function scorePV(p){ return ({none:0, small:-4, med:-7, large:-10})[p] ?? 0; }

function classFromIndex(idx){
  if(idx <= 18) return "A4‚ÄìA2";
  if(idx <= 28) return "A1";
  if(idx <= 38) return "B";
  if(idx <= 50) return "C";
  if(idx <= 64) return "D";
  if(idx <= 78) return "E";
  if(idx <= 92) return "F";
  return "G";
}
function classLabel(cls){
  const map = { "A4‚ÄìA2":"Molto efficiente", "A1":"Efficiente", "B":"Buona", "C":"Discreta", "D":"Media", "E":"Scarsa", "F":"Molto scarsa", "G":"Critica" };
  return map[cls] || "";
}
function sevFromIdx(idx){
  if(idx <= 38) return "good";
  if(idx <= 64) return "warn";
  return "bad";
}
function euroHint(idx, area){
  const base = (area/80) * 900;
  const mult = 0.6 + (idx/100)*1.4;
  const est = Math.round(base*mult/50)*50;
  return `Spesa annua riscaldamento (ordine di grandezza): ~‚Ç¨${est}`;
}
function buildMailto(sum){
  const to = "marco.hotplay@hotmail.it";
  const phone = "+393463156763";
  const subject = encodeURIComponent("Richiesta sopralluogo / APE (CheckApp Energetico)");
  const body = encodeURIComponent(
`Ciao,
ho effettuato un CheckApp Energetico orientativo e vorrei un contatto per sopralluogo / APE.

Riepilogo:
${JSON.stringify(sum, null, 2)}

Contatto WhatsApp: ${phone}

Note:
${v("notes") || "-"}`
  );
  return `mailto:${to}?subject=${subject}&body=${body}`;
}

function buildWhatsApp(sum){
  const phone = "393463156763"; // WhatsApp Business (senza +)
  const text = encodeURIComponent(
`Ciao Marco, ho fatto un CheckApp Energetico e vorrei prenotare un sopralluogo / APE.

Riepilogo:
${JSON.stringify(sum, null, 2)}

Note:
${v("notes") || "-"}`
  );
  return `https://wa.me/${phone}?text=${text}`;
}




function colorForClass(cls){
  // cls can be "A4‚ÄìA2", "A1", "B", "C", "D", "E", "F", "G"
  if(cls==="A4‚ÄìA2") return getComputedStyle(document.documentElement).getPropertyValue("--A2").trim() || "#43a047";
  const map = {A1:"--A1", B:"--B", C:"--C", D:"--D", E:"--E", F:"--F", G:"--G"};
  const key = map[cls];
  if(!key) return "#60a5fa";
  return getComputedStyle(document.documentElement).getPropertyValue(key).trim();
}
function pinPosFromClass(cls){
  // position across 10 segments: A4 A3 A2 A1 B C D E F G
  // For A4‚ÄìA2, point at A2 segment.
  const segIndex = (cls==="A4‚ÄìA2") ? 2 : ({A1:3,B:4,C:5,D:6,E:7,F:8,G:9}[cls] ?? 6);
  // Each segment treated as 10% except B..F 12%. We'll approximate with cumulative based on widths above.
  const widths = [10,10,10,10,12,12,12,12,12,10];
  const cum = [0]
  for(let w of widths) cum.push(cum[cum.length-1]+w);
  const left = cum[segIndex] + widths[segIndex]/2; // center of segment
  return left; // percent
}

function calc(){
  const area = clamp(n("area"), 10, 500);
  const h = clamp(n("height"), 2.2, 3.5);

  let idx = 0;
  idx += scoreClimate(v("climate"));
  idx += scoreYear(v("yearBand"));
  idx += scoreType(v("type"));
  idx += scoreExposure(v("exposure"));
  idx += scoreIns(v("wallIns"), "wall");
  idx += scoreIns(v("roofIns"), "roof");
  idx += scoreWindows(v("windows"));
  idx += scoreAirtight(v("airtight"));
  idx += scoreHeat(v("heat"));
  idx += scoreEmitters(v("emitters"));
  idx += scoreControls(v("controls"));
  idx += scoreDHW(v("dhw"));
  idx += scorePV(v("pv"));
  idx = clamp(idx, 5, 110);

  const cls = classFromIndex(idx);
  const sev = sevFromIdx(idx);

  const sevBadge = document.getElementById("sevBadge");
  const dot = sev === "good" ? "good" : (sev==="bad" ? "bad" : "warn");
  const sevText = sev === "good" ? "Buona situazione" : (sev==="bad" ? "Criticit√† alta" : "Da migliorare");
  sevBadge.innerHTML = `<span class="dot ${dot}"></span><span>${sevText}</span>`;

  document.getElementById("idxPill").innerHTML = `Indice: <b>${idx.toFixed(0)}/100</b>`;
  document.getElementById("classPill").innerHTML = `Classe: <span class="classTag"><span class="swatch" style="background:${colorForClass(cls)}"></span><b>${cls}</b></span> <span class="small">(${classLabel(cls)})</span>`;
  document.getElementById("volPill").innerHTML = `Volume: <b>${Math.round(area*h)} m¬≥</b>`;

  const pct = Math.round(((idx-5)/(110-5))*100);
  document.getElementById("bar").style.width = pct + "%";
  document.getElementById("bar").style.background = "linear-gradient(90deg, var(--A4), var(--A3), var(--A2), var(--A1), var(--B), var(--C), var(--D), var(--E), var(--F), var(--G))";
  document.getElementById("bar").style.opacity = "0.95";

  let adv = [];
  const wall = v("wallIns"), roof = v("roofIns"), win = v("windows"), air = v("airtight");
  const heat = v("heat"), ctrl = v("controls"), pv = v("pv"), dhw = v("dhw");

  if(wall==="none") adv.push("Isolamento pareti (cappotto mirato): riduce dispersioni e migliora comfort.");
  if(roof==="none" && (v("exposure")==="top" || v("type")==="house")) adv.push("Isolamento copertura/solaio: ottimo rapporto beneficio/costo su ultimo piano o casa indipendente.");
  if(win==="single") adv.push("Infissi: sostituzione/riqualifica + posa corretta (nastri/controtelaio) per ridurre spifferi.");
  if(air==="poor") adv.push("Tenuta all‚Äôaria: guarnizioni, cassonetti, sigillature (spesso low-cost, alta resa).");
  if(heat==="old_boiler") adv.push("Generatore: valutare caldaia a condensazione o PDC + bilanciamento impianto.");
  if(ctrl!=="smart") adv.push("Regolazione: termostato evoluto + valvole/zone (moltiplicatore di efficienza).");
  if(dhw==="old") adv.push("ACS: valutare PDC ACS o integrazione solare termico (se consumi elevati).");
  if(pv==="none") adv.push("Fotovoltaico: se fattibile, anche piccolo supporta consumi e futura PDC.");

  if(adv.length===0) adv.push("Sei gi√† messo bene: punta su regolazione, manutenzione e piccoli miglioramenti di comfort/consumi.");
  adv = adv.slice(0,5);

  document.getElementById("adviceBox").innerHTML =
    `<ul>${adv.map(x=>`<li>${x}</li>`).join("")}</ul><div class="small" style="margin-top:10px;color:rgba(255,255,255,.70)">Step consigliato: sopralluogo + APE/diagnosi per quantificare benefici e priorit√†.</div>`;

  const sum = {
    cliente: v("client") || null,
    comune: v("city") || null,
    superficie_mq: area,
    altezza_m: h,
    zona_climatica: v("climate"),
    anno_banda: v("yearBand"),
    tipologia: v("type"),
    posizione: v("exposure"),
    pareti: wall,
    copertura: roof,
    infissi: win,
    tenuta_aria: air,
    riscaldamento: heat,
    terminali: v("emitters"),
    regolazione: ctrl,
    acs: dhw,
    fotovoltaico: pv,
    note: v("notes") || null,
    indice_screening: idx.toFixed(0),
    classe_stimata: cls
  };
  document.getElementById("summary").textContent = JSON.stringify(sum, null, 2);

  document.getElementById("ctaEmail").href = buildMailto(sum);
  document.getElementById("ctaWhatsApp").href = buildWhatsApp(sum);
  document.getElementById("costHint").textContent = euroHint(idx, area);

  document.getElementById("printMeta").textContent = new Date().toLocaleString("it-IT");
  document.getElementById("printData").textContent = JSON.stringify(sum, null, 2);
  document.getElementById("printResult").innerHTML =
    `<div><b>Indice:</b> ${idx.toFixed(0)}/100 ‚Ä¢ <b>Classe stimata:</b> ${cls} (${classLabel(cls)}) ‚Ä¢ <b>Volume:</b> ${Math.round(area*h)} m¬≥</div>
     <div style="margin-top:6px">${euroHint(idx, area)} (indicativo)</div>`;
  document.getElementById("printAdvice").innerHTML = `<ul>${adv.map(x=>`<li>${x}</li>`).join("")}</ul>`;
}

function resetForm(){
  ["client","city","notes"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("area").value=80;
  document.getElementById("height").value=2.7;
  document.getElementById("yearBand").value="70_90";
  document.getElementById("climate").value="D";
  document.getElementById("type").value="apartment";
  document.getElementById("exposure").value="middle";
  document.getElementById("wallIns").value="none";
  document.getElementById("windows").value="single";
  document.getElementById("airtight").value="poor";
  document.getElementById("roofIns").value="none";
  document.getElementById("heat").value="old_boiler";
  document.getElementById("emitters").value="radiators";
  document.getElementById("controls").value="none";
  document.getElementById("dhw").value="old";
  document.getElementById("pv").value="none";

  document.getElementById("sevBadge").innerHTML = `<span class="dot warn"></span><span>In attesa di calcolo</span>`;
  document.getElementById("idxPill").textContent="Indice: ‚Äî";
  document.getElementById("classPill").textContent="Classe: ‚Äî";
  document.getElementById("volPill").textContent="Volume: ‚Äî";
  document.getElementById("bar").style.width="0%";
  document.getElementById("adviceBox").textContent="‚Äî";
  document.getElementById("summary").textContent="‚Äî";
  document.getElementById("ctaEmail").href="#";
  document.getElementById("costHint").textContent="‚Äî";
}

async function copySummary(){
  const txt = document.getElementById("summary").textContent;
  if(!txt || txt==="‚Äî"){ alert("Calcola prima il risultato."); return; }
  try{ await navigator.clipboard.writeText(txt); alert("Copiato."); }
  catch(e){ alert("Copia non disponibile: seleziona il testo e copia manualmente."); }
}

function exportPDF(){
  const txt = document.getElementById("summary").textContent;
  if(!txt || txt==="‚Äî"){ alert("Calcola prima il risultato."); return; }
  window.print();
}

function collectForm(){
  const ids = ["client","city","area","height","yearBand","climate","type","exposure","wallIns","windows","airtight","roofIns","heat","emitters","controls","dhw","pv","notes"];
  const o = {};
  ids.forEach(id=> o[id] = document.getElementById(id).value );
  return o;
}
function applyForm(o){
  Object.keys(o||{}).forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = o[id];
  });
}
function saveDraft(){
  localStorage.setItem("qc_energy_draft_v3", JSON.stringify(collectForm()));
  alert("Bozza salvata su questo dispositivo.");
}
function loadDraft(){
  const raw = localStorage.getItem("qc_energy_draft_v3");
  if(!raw){ alert("Nessuna bozza salvata."); return; }
  try{ applyForm(JSON.parse(raw)); alert("Bozza caricata."); }
  catch(e){ alert("Bozza non valida."); }
}
</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    });
  }
</script>

</body>
</html>
