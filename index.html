<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckApp Energetico</title>
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="icon-192.png" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --card:#ffffff;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --r:18px;
      --brand:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(14,165,233,.12), transparent 50%),
                  radial-gradient(900px 450px at 90% 10%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:26px auto;padding:0 16px}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; background:rgba(255,255,255,.75);
      border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .brand img{width:46px;height:46px;border-radius:14px;box-shadow:0 6px 16px rgba(2,6,23,.12)}
    .brand h1{font-size:18px; margin:0; line-height:1.15}
    .brand p{margin:2px 0 0; font-size:12.5px; color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 12px; border-radius:14px; cursor:pointer; font-weight:650;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn.primary{background:linear-gradient(180deg, rgba(14,165,233,.18), rgba(14,165,233,.06)); border-color:rgba(14,165,233,.35)}
    .btn:active{transform:translateY(1px)}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .actions{justify-content:flex-start} }
    .card{
      background:rgba(255,255,255,.82);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .note{
      border:1px dashed rgba(2,6,23,.18);
      background:rgba(2,6,23,.03);
      border-radius:14px;
      padding:10px 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      margin-bottom:14px;
    }
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 680px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px; font-weight:650}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(2,6,23,.04);
    }
    textarea{min-height:84px; resize:vertical}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .pillrow{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.9); font-size:13px; font-weight:700;
      display:inline-flex; gap:8px; align-items:center;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8}
    .big{font-size:18px}
    .muted{color:var(--muted)}
    .ok{background:#22c55e}
    .warn{background:#f59e0b}
    .bad{background:#ef4444}

    /* scale */
    .scaleWrap{margin-top:10px}
    .scale{
      position:relative;
      height:22px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow: inset 0 1px 0 rgba(2,6,23,.06);
      background:#fff;
      display:grid;
      grid-template-columns: repeat(10, 1fr);
    }
    .seg{height:100%}
    .scaleLabels{
      display:flex; justify-content:space-between; font-size:11px; color:var(--muted);
      margin-top:6px; padding:0 2px;
      user-select:none;
    }
    .marker{
      position:absolute;
      top:-8px;
      width:0;height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-top:12px solid #0f172a;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.18));
      transform: translateX(-8px);
    }
    .readyBox{
      margin-top:12px;
      border-radius:16px;
      padding:12px 12px;
      border:1px solid var(--line);
      background:rgba(2,6,23,.02);
      display:flex; gap:10px; align-items:flex-start;
    }
    .readyTitle{font-weight:800; margin:0}
    .readyText{margin:2px 0 0; color:var(--muted); font-size:13px; line-height:1.35}
    .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .ctaRow a{ text-decoration:none }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
    }
    .tiny{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img src="icon-192.png" alt="Logo" />
        <div>
          <h1>CheckApp Energetico</h1>
          <p>Screening orientativo + interventi prioritari (non APE). Utile quanto basta per decidere il prossimo passo.</p>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnCalc">‚ö° Calcola</button>
        <button class="btn" id="btnSave">üíæ Salva</button>
        <button class="btn" id="btnLoad">üìÇ Carica</button>
        <button class="btn" id="btnPdf">üßæ Report PDF</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Dati immobile</h2>
        <div class="note">
          <b>Disclaimer:</b> output indicativo. Per certificazione APE servono rilievi e calcoli secondo normativa vigente.
          Qui stimiamo una <span class="kbd">classe</span> e un <span class="kbd">livello criticit√†</span> per capire dove intervenire prima.
        </div>

        <div class="row">
          <div>
            <label>Cliente / riferimento (facoltativo)</label>
            <input id="cliente" placeholder="Es. Rossi Mario" />
          </div>
          <div>
            <label>Comune (facoltativo)</label>
            <input id="comune" placeholder="Es. Roma" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Superficie (m¬≤)</label>
            <input id="superficie" type="number" min="10" step="1" value="80" />
          </div>
          <div>
            <label>Altezza media (m)</label>
            <input id="altezza" type="number" min="2" step="0.1" value="2.7" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Anno di costruzione / ristrutturazione principale</label>
          <select id="anno_banda">
            <option value="pre70">Prima del 1970</option>
            <option value="70_90" selected>1970‚Äì1990</option>
            <option value="90_05">1990‚Äì2005</option>
            <option value="05_15">2005‚Äì2015</option>
            <option value="post15">Dopo il 2015</option>
          </select>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Zona climatica (indicativa)</label>
            <select id="zona">
              <option value="A">A</option><option value="B">B</option><option value="C">C</option>
              <option value="D" selected>D</option><option value="E">E</option><option value="F">F</option>
            </select>
          </div>
          <div>
            <label>Orientamento prevalente</label>
            <select id="orientamento">
              <option value="N">Nord</option>
              <option value="E">Est</option>
              <option value="S" selected>Sud</option>
              <option value="W">Ovest</option>
              <option value="mix">Misto</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Tipologia</label>
            <select id="tipologia">
              <option value="apartment" selected>Appartamento</option>
              <option value="single">Villetta / unifamiliare</option>
              <option value="multi">Plurifamiliare</option>
            </select>
          </div>
          <div>
            <label>Posizione</label>
            <select id="posizione">
              <option value="intermedio" selected>Intermedio</option>
              <option value="piano_terra">Piano terra</option>
              <option value="ultimo">Ultimo piano</option>
              <option value="angolo">Angolare / molta esposizione</option>
            </select>
          </div>
        </div>

        <div class="sep"></div>
        <h2>Involucro</h2>

        <div class="row">
          <div>
            <label>Isolamento pareti</label>
            <select id="pareti">
              <option value="none" selected>Assente / minimo</option>
              <option value="some">Parziale</option>
              <option value="good">Buono</option>
            </select>
          </div>
          <div>
            <label>Copertura / solaio verso esterno</label>
            <select id="copertura">
              <option value="none">Assente</option>
              <option value="some" selected>Parziale</option>
              <option value="good">Buono</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Infissi: materiale</label>
            <select id="infissi_materiale">
              <option value="old" selected>Vecchi / singolo vetro</option>
              <option value="pvc">PVC</option>
              <option value="wood">Legno</option>
              <option value="al">Alluminio</option>
            </select>
          </div>
          <div>
            <label>Alluminio: taglio termico?</label>
            <select id="taglio_termico">
              <option value="na" selected>Non applicabile</option>
              <option value="no">No</option>
              <option value="yes">S√¨</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Numero finestre</label>
            <input id="num_finestre" type="number" min="0" step="1" value="6" />
          </div>
          <div>
            <label>Numero porte-finestre</label>
            <input id="num_portefinestre" type="number" min="0" step="1" value="1" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Tenuta all‚Äôaria (spifferi)</label>
          <select id="tenuta_aria">
            <option value="poor" selected>Scarsa</option>
            <option value="avg">Media</option>
            <option value="good">Buona</option>
          </select>
        </div>

        <div class="sep"></div>
        <h2>Impianti</h2>

        <div class="row">
          <div>
            <label>Riscaldamento</label>
            <select id="riscaldamento">
              <option value="none">Assente / stufe</option>
              <option value="old">Caldaia tradizionale</option>
              <option value="condensing" selected>Caldaia a condensazione</option>
              <option value="hp">Pompa di calore (PDC)</option>
            </select>
          </div>
          <div>
            <label>Riscaldamento condominiale?</label>
            <select id="condominiale">
              <option value="no" selected>No</option>
              <option value="yes">S√¨</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Raffrescamento presente?</label>
            <select id="raffrescamento">
              <option value="no" selected>No</option>
              <option value="yes">S√¨</option>
            </select>
          </div>
          <div>
            <label>Tipo raffrescamento</label>
            <select id="raff_tipo">
              <option value="na" selected>‚Äî</option>
              <option value="dx">Espansione diretta (split / motocondensante)</option>
              <option value="chiller">Chiller</option>
              <option value="hp">PDC (reversibile)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Terminali</label>
            <select id="terminali">
              <option value="radiators" selected>Radiatori</option>
              <option value="floor">Pavimento radiante</option>
              <option value="fancoil">Fancoil</option>
              <option value="mixed">Misti</option>
            </select>
          </div>
          <div>
            <label>Regolazione</label>
            <select id="regolazione">
              <option value="none">Assente</option>
              <option value="basic" selected>Termostato base</option>
              <option value="smart">Smart / zonale</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>ACS (acqua calda sanitaria)</label>
            <select id="acs">
              <option value="old">Scaldabagno elettrico / vecchio</option>
              <option value="condensing" selected>Da caldaia</option>
              <option value="hp">PDC / bollitore in pompa di calore</option>
              <option value="solar">Solare termico</option>
            </select>
          </div>
          <div>
            <label>Fotovoltaico</label>
            <select id="fotovoltaico">
              <option value="none" selected>Assente</option>
              <option value="small">Piccolo (&lt;3 kWp)</option>
              <option value="mid">Medio (3‚Äì6 kWp)</option>
              <option value="big">Grande (&gt;6 kWp)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Note (facoltative)</label>
          <textarea id="note" placeholder="Esempio: ultimo piano senza cappotto, infissi nuovi 2021, split recenti..."></textarea>
        </div>

        <div class="tiny">Suggerimento: dopo le modifiche, premi <span class="kbd">Calcola</span> e poi <span class="kbd">Salva</span>.</div>
      </div>

      <div class="card">
        <h2>Risultato</h2>
        <div class="pillrow" style="margin-bottom:10px">
          <div class="pill"><span class="dot" id="dotState"></span> <span id="stateText">In attesa di calcolo</span></div>
          <div class="pill">Indice: <span class="big" id="indice">‚Äî</span></div>
          <div class="pill">Classe: <span class="big" id="classe">‚Äî</span></div>
          <div class="pill">Volume: <span class="big" id="volume">‚Äî</span> m¬≥</div>
        </div>

        <div class="scaleWrap">
          <div class="scale" id="scale">
            <div class="seg" style="background:#0b8a3a"></div>
            <div class="seg" style="background:#1e9b43"></div>
            <div class="seg" style="background:#43b047"></div>
            <div class="seg" style="background:#78c850"></div>
            <div class="seg" style="background:#b9d84b"></div>
            <div class="seg" style="background:#f0e24b"></div>
            <div class="seg" style="background:#f2c24a"></div>
            <div class="seg" style="background:#e68b3b"></div>
            <div class="seg" style="background:#d55a3a"></div>
            <div class="seg" style="background:#c92f2f"></div>
            <div class="marker" id="marker" style="left:5%"></div>
          </div>
          <div class="scaleLabels">
            <span>NZEB</span><span>A4</span><span>A3</span><span>A2</span><span>A1</span><span>B</span><span>C</span><span>D</span><span>E</span><span>F</span><span>G</span>
          </div>
        </div>

        <div class="readyBox" id="readyBox">
          <span class="dot" id="readyDot"></span>
          <div>
            <p class="readyTitle" id="readyTitle">2030: non calcolato</p>
            <p class="readyText" id="readyText">Compila i dati e premi Calcola.</p>
          </div>
        </div>

        <div class="sep"></div>
        <h2>Interventi consigliati</h2>
        <div id="interventi" class="muted">‚Äî</div>

        <div class="sep"></div>
        <h2>Prossimo passo</h2>
        <p class="muted" style="margin:0 0 10px">Se vuoi numeri veri: sopralluogo + APE/diagnosi + piano interventi.</p>
        <div class="ctaRow">
          <a class="btn primary" id="ctaEmail" href="#">üìß Prenota sopralluogo (Email)</a>
          <a class="btn" id="ctaWapp" href="#" target="_blank" rel="noopener">üí¨ Prenota su WhatsApp</a>
        </div>
        <div class="tiny">Email: <span class="kbd">marco.hotplay@hotmail.it</span> ¬∑ WhatsApp Business: <span class="kbd">+39 346 315 6763</span></div>
      </div>
    </div>
  </div>

  <script>
    // PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(()=>{}));
    }

    const $ = (id) => document.getElementById(id);

    const CLASSES = ["NZEB","A4","A3","A2","A1","B","C","D","E","F","G"];

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function computeScore(d){
      let score = 0;

      // anno
      const annoW = {pre70:18, "70_90":14, "90_05":10, "05_15":6, post15:2};
      score += (annoW[d.anno_banda] ?? 10);

      // zona climatica
      const zonaW = {A:2, B:4, C:7, D:10, E:13, F:16};
      score += (zonaW[d.zona] ?? 10);

      // tipologia/posizione
      const posW = {intermedio:2, piano_terra:6, ultimo:8, angolo:9};
      score += (posW[d.posizione] ?? 6);
      if (d.tipologia !== "apartment") score += 5;

      // orientamento
      const oriW = {N:6, E:3, S:2, W:4, mix:3};
      score += (oriW[d.orientamento] ?? 3);

      // involucro
      const insW = {none:18, some:10, good:3};
      score += (insW[d.pareti] ?? 12);
      score += (insW[d.copertura] ?? 12);

      // infissi/materiale
      // old = pesante, pvc/legno medi, alluminio dipende dal taglio termico
      if (d.infissi_materiale === "old") score += 16;
      if (d.infissi_materiale === "pvc") score += 6;
      if (d.infissi_materiale === "wood") score += 7;
      if (d.infissi_materiale === "al") {
        score += (d.taglio_termico === "yes") ? 7 : 13;
      }
      // tenuta aria
      const airW = {poor:10, avg:6, good:2};
      score += (airW[d.tenuta_aria] ?? 6);

      // superfici vetrate proxy: finestre/porte-finestre
      const nwin = clamp((d.num_finestre||0) + (d.num_portefinestre||0)*1.6, 0, 30);
      score += clamp(nwin * 0.6, 0, 12);

      // impianti riscaldamento
      const heatW = {none:18, old:12, condensing:6, hp:3};
      score += (heatW[d.riscaldamento] ?? 10);
      if (d.condominiale === "yes") score += 2; // spesso meno regolabile

      // raffrescamento
      if (d.raffrescamento === "yes"){
        const coolW = {dx:5, chiller:7, hp:3};
        score += (coolW[d.raff_tipo] ?? 5);
      }

      // terminali / regolazione / ACS
      const termW = {radiators:6, fancoil:5, floor:3, mixed:6};
      score += (termW[d.terminali] ?? 5);

      const regW = {none:6, basic:3, smart:0};
      score += (regW[d.regolazione] ?? 3);

      const acsW = {old:7, condensing:3, hp:1, solar:0};
      score += (acsW[d.acs] ?? 3);

      // FV
      const pvW = {none:6, small:4, mid:2, big:0};
      score += (pvW[d.fotovoltaico] ?? 4);

      // normalizza 0-100-ish
      score = clamp(Math.round(score), 0, 120);
      return score;
    }

    function scoreToClass(score){
      // pi√π score = peggio. soglie indicative
      if (score <= 10) return "NZEB";
      if (score <= 16) return "A4";
      if (score <= 22) return "A3";
      if (score <= 30) return "A2";
      if (score <= 38) return "A1";
      if (score <= 48) return "B";
      if (score <= 60) return "C";
      if (score <= 72) return "D";
      if (score <= 86) return "E";
      if (score <= 100) return "F";
      return "G";
    }

    function classLabel(c){
      if (c === "G") return "G (Critica)";
      if (c === "F") return "F (Molto bassa)";
      if (c === "E") return "E (Bassa)";
      if (c === "D") return "D (Migliorabile)";
      if (c === "C") return "C (Buona)";
      if (c === "B") return "B (Molto buona)";
      if (c.startsWith("A") || c === "NZEB") return c + " (Alta)";
      return c;
    }

    function setMarker(cls){
      const idx = CLASSES.indexOf(cls);
      const pct = ((idx)/(CLASSES.length-1)) * 100; // 0..100
      $("marker").style.left = pct + "%";
    }

    function buildInterventi(d, cls){
      const out = [];
      if (d.pareti !== "good") out.push("Isolamento pareti (cappotto mirato): riduce dispersioni e migliora comfort.");
      if (d.copertura !== "good") out.push("Isolamento copertura/solaio verso esterno: spesso alto rendimento ‚Ç¨/kWh.");
      if (d.tenuta_aria === "poor") out.push("Tenuta all‚Äôaria: guarnizioni, cassonetti, sigillature (spesso low-cost, alta resa).");
      if (d.infissi_materiale === "old" || (d.infissi_materiale==="al" && d.taglio_termico!=="yes")) out.push("Infissi: valutare sostituzione o retrofit (vetro/guarnizioni) dove ha pi√π senso.");
      if (d.riscaldamento === "old" || d.riscaldamento === "none") out.push("Generatore: passare a condensazione o PDC (compatibilmente con impianto e potenze).");
      if (d.regolazione !== "smart") out.push("Regolazione: valvole termostatiche / cronotermostato / zonale smart.");
      if (d.fotovoltaico === "none") out.push("Fotovoltaico: se fattibile, anche piccolo supporta consumi e futura PDC.");
      if (d.raffrescamento === "yes" && d.raff_tipo === "chiller") out.push("Raffrescamento: verificare efficienza chiller e strategie di regolazione/terminali.");
      if (out.length === 0) out.push("Nessuna criticit√† evidente. S√¨, ogni tanto succede.");
      return "<ul>" + out.map(x=>`<li>${x}</li>`).join("") + "</ul>";
    }

    function gather(){
      const d = {
        cliente: $("cliente").value.trim(),
        comune: $("comune").value.trim(),
        superficie_mq: Number($("superficie").value || 0),
        altezza_m: Number($("altezza").value || 0),
        anno_banda: $("anno_banda").value,
        zona: $("zona").value,
        orientamento: $("orientamento").value,
        tipologia: $("tipologia").value,
        posizione: $("posizione").value,
        pareti: $("pareti").value,
        copertura: $("copertura").value,
        infissi_materiale: $("infissi_materiale").value,
        taglio_termico: $("taglio_termico").value,
        num_finestre: Number($("num_finestre").value || 0),
        num_portefinestre: Number($("num_portefinestre").value || 0),
        tenuta_aria: $("tenuta_aria").value,
        riscaldamento: $("riscaldamento").value,
        condominiale: $("condominiale").value,
        raffrescamento: $("raffrescamento").value,
        raff_tipo: $("raff_tipo").value,
        terminali: $("terminali").value,
        regolazione: $("regolazione").value,
        acs: $("acs").value,
        fotovoltaico: $("fotovoltaico").value,
        note: $("note").value.trim(),
      };
      return d;
    }

    function apply(d){
      $("cliente").value = d.cliente ?? "";
      $("comune").value = d.comune ?? "";
      $("superficie").value = d.superficie_mq ?? 80;
      $("altezza").value = d.altezza_m ?? 2.7;
      $("anno_banda").value = d.anno_banda ?? "70_90";
      $("zona").value = d.zona ?? "D";
      $("orientamento").value = d.orientamento ?? "S";
      $("tipologia").value = d.tipologia ?? "apartment";
      $("posizione").value = d.posizione ?? "intermedio";
      $("pareti").value = d.pareti ?? "none";
      $("copertura").value = d.copertura ?? "some";
      $("infissi_materiale").value = d.infissi_materiale ?? "old";
      $("taglio_termico").value = d.taglio_termico ?? "na";
      $("num_finestre").value = d.num_finestre ?? 6;
      $("num_portefinestre").value = d.num_portefinestre ?? 1;
      $("tenuta_aria").value = d.tenuta_aria ?? "poor";
      $("riscaldamento").value = d.riscaldamento ?? "condensing";
      $("condominiale").value = d.condominiale ?? "no";
      $("raffrescamento").value = d.raffrescamento ?? "no";
      $("raff_tipo").value = d.raff_tipo ?? "na";
      $("terminali").value = d.terminali ?? "radiators";
      $("regolazione").value = d.regolazione ?? "basic";
      $("acs").value = d.acs ?? "condensing";
      $("fotovoltaico").value = d.fotovoltaico ?? "none";
      $("note").value = d.note ?? "";
    }

    function setStatus(kind, text){
      const dot = $("dotState");
      dot.className = "dot " + (kind==="ok"?"ok":kind==="warn"?"warn":kind==="bad"?"bad":"");
      $("stateText").textContent = text;
    }

    function calcola(){
      const d = gather();
      const vol = Math.max(0, Math.round((d.superficie_mq||0) * (d.altezza_m||0)));
      const score = computeScore(d);
      const cls = scoreToClass(score);

      $("volume").textContent = vol ? String(vol) : "‚Äî";
      $("indice").textContent = String(score) + "/120";
      $("classe").textContent = classLabel(cls);

      setMarker(cls);

      // Stato
      if (["NZEB","A4","A3","A2","A1","B","C"].includes(cls)) setStatus("ok","Buono (ma non cantare vittoria)");
      else if (cls === "D") setStatus("warn","Migliorabile");
      else setStatus("bad","Criticit√† alta");

      // 2030 readyness (messaggio orientativo)
      const ready = ["NZEB","A4","A3","A2","A1","B","C","D"].includes(cls);
      $("readyDot").className = "dot " + (ready ? "ok" : "bad");
      $("readyTitle").textContent = ready ? "2030: tendenzialmente OK (‚â•D)" : "2030: NON OK (<D)";
      $("readyText").textContent = ready
        ? "Se l‚Äôobiettivo √® stare almeno in D, questa stima non suona male. Per una risposta seria: rilievo + calcolo."
        : "Con questa stima sei sotto D: conviene pianificare interventi. Il che √® divertente solo per chi vende cappotti.";

      $("interventi").innerHTML = buildInterventi(d, cls);

      // CTA links
      const email = "marco.hotplay@hotmail.it";
      const phone = "+393463156763";
      const subject = encodeURIComponent("Prenotazione sopralluogo APE / diagnosi energetica");
      const body = encodeURIComponent(
        "Ciao Marco,%0D%0A%0D%0A" +
        "Vorrei prenotare un sopralluogo.%0D%0A" +
        "Dati (indicativi):%0D%0A" +
        "- Comune: " + (d.comune||"") + "%0D%0A" +
        "- Superficie: " + (d.superficie_mq||"") + " m¬≤%0D%0A" +
        "- Classe stimata: " + cls + "%0D%0A" +
        "- Note: " + (d.note||"") + "%0D%0A%0D%0A" +
        "Contatto telefonico:%0D%0A"
      );
      $("ctaEmail").href = `mailto:${email}?subject=${subject}&body=${body}`;
      const wmsg = encodeURIComponent(`Ciao Marco, vorrei prenotare un sopralluogo. Comune: ${d.comune||""}, sup: ${d.superficie_mq||""} m¬≤, classe stimata: ${cls}.`);
      $("ctaWapp").href = `https://wa.me/${phone.replace("+","")}?text=${wmsg}`;
    }

    function saveDraft(){
      const d = gather();
      localStorage.setItem("checkappEnergetico:v11", JSON.stringify(d));
      setStatus("ok","Salvato sul dispositivo");
    }

    function loadDraft(){
      const raw = localStorage.getItem("checkappEnergetico:v11");
      if (!raw){ setStatus("warn","Nessun salvataggio trovato"); return; }
      try{
        const d = JSON.parse(raw);
        apply(d);
        setStatus("ok","Caricato");
      }catch(e){
        setStatus("bad","Salvataggio corrotto");
      }
    }

    function reportPDF(){
      // genera un report HTML stampabile (l‚Äôutente poi salva in PDF)
      const d = gather();
      const score = computeScore(d);
      const cls = scoreToClass(score);
      const vol = Math.max(0, Math.round((d.superficie_mq||0) * (d.altezza_m||0)));

      const interventions = buildInterventi(d, cls);
      const ready = ["NZEB","A4","A3","A2","A1","B","C","D"].includes(cls);

      const html = `
<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Report CheckApp Energetico</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:28px;color:#0f172a}
  .hdr{display:flex;gap:14px;align-items:center}
  .logo{width:54px;height:54px;border-radius:16px;box-shadow:0 6px 18px rgba(2,6,23,.12)}
  h1{margin:0;font-size:20px}
  .muted{color:#475569}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px}
  .card{border:1px solid #e2e8f0;border-radius:16px;padding:14px}
  .k{font-size:12px;color:#475569;font-weight:700}
  .v{font-size:16px;font-weight:800;margin-top:2px}
  .scale{margin-top:12px;border:1px solid #e2e8f0;border-radius:999px;overflow:hidden;height:18px;display:grid;grid-template-columns:repeat(10,1fr)}
  .seg{height:100%}
  .row{margin-top:14px}
  ul{margin:8px 0 0 18px}
  @media print{ .noprint{display:none} body{margin:0} }
</style>
</head>
<body>
  <div class="hdr">
    <img class="logo" src="icon-192.png" alt="logo"/>
    <div>
      <h1>CheckApp Energetico</h1>
      <div class="muted">Report sintetico (screening orientativo, non APE)</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="k">Cliente</div><div class="v">${(d.cliente||"‚Äî").replaceAll("<","&lt;")}</div>
      <div class="k" style="margin-top:10px">Comune</div><div class="v">${(d.comune||"‚Äî").replaceAll("<","&lt;")}</div>
      <div class="k" style="margin-top:10px">Superficie / Altezza / Volume</div>
      <div class="v">${d.superficie_mq||"‚Äî"} m¬≤ ¬∑ ${d.altezza_m||"‚Äî"} m ¬∑ ${vol||"‚Äî"} m¬≥</div>
      <div class="k" style="margin-top:10px">Anno / Zona / Orientamento</div>
      <div class="v">${d.anno_banda} ¬∑ ${d.zona} ¬∑ ${d.orientamento}</div>
    </div>

    <div class="card">
      <div class="k">Indice screening</div><div class="v">${score}/120</div>
      <div class="k" style="margin-top:10px">Classe stimata</div><div class="v">${classLabel(cls)}</div>

      <div class="scale">
        <div class="seg" style="background:#0b8a3a"></div>
        <div class="seg" style="background:#1e9b43"></div>
        <div class="seg" style="background:#43b047"></div>
        <div class="seg" style="background:#78c850"></div>
        <div class="seg" style="background:#b9d84b"></div>
        <div class="seg" style="background:#f0e24b"></div>
        <div class="seg" style="background:#f2c24a"></div>
        <div class="seg" style="background:#e68b3b"></div>
        <div class="seg" style="background:#d55a3a"></div>
        <div class="seg" style="background:#c92f2f"></div>
      </div>
      <div class="muted" style="margin-top:8px">2030 (orientativo): <b>${ready ? "OK (‚â•D)" : "NON OK (<D)"}</b></div>
    </div>
  </div>

  <div class="card row">
    <div class="k">Interventi consigliati</div>
    ${interventions}
  </div>

  <div class="card row">
    <div class="k">Contatto</div>
    <div class="v">marco.hotplay@hotmail.it ¬∑ +39 346 315 6763</div>
    <div class="muted" style="margin-top:8px">Disclaimer: indicazione preliminare. Per APE servono rilievi e calcoli secondo normativa.</div>
  </div>

  <div class="noprint muted" style="margin-top:14px">Suggerimento: dal menu di stampa scegli ‚ÄúSalva come PDF‚Äù.</div>
  <script>window.print();</script>
</body>
</html>`;
      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    function wire(){
      $("btnCalc").addEventListener("click", calcola);
      $("btnSave").addEventListener("click", saveDraft);
      $("btnLoad").addEventListener("click", loadDraft);
      $("btnPdf").addEventListener("click", reportPDF);

      // logica infissi alluminio/taglio termico
      $("infissi_materiale").addEventListener("change", () => {
        const v = $("infissi_materiale").value;
        $("taglio_termico").value = (v === "al") ? "no" : "na";
        $("taglio_termico").disabled = (v !== "al");
      });
      $("taglio_termico").disabled = ($("infissi_materiale").value !== "al");

      // logica raffrescamento
      $("raffrescamento").addEventListener("change", () => {
        const on = $("raffrescamento").value === "yes";
        $("raff_tipo").disabled = !on;
        if (!on) $("raff_tipo").value = "na";
      });
      $("raff_tipo").disabled = ($("raffrescamento").value !== "yes");
    }

    wire();
  </script>
</body>
</html>
